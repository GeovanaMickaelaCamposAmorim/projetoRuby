<% content_for :page_title, "Movimentações da Ficha" %>
<% content_for :page_description, "Gerencie e monitore movimentações dos crediários" %>
<% content_for :page_icon do %>
  <span class="material-symbols-outlined text-xl">payments</span>
<% end %>

<!-- Botão de voltar -->
<div class="mb-4 flex items-center gap-3">
  <a href="<%= ficha_crediarios_path %>" 
     class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium 
            bg-white border border-gray-300 rounded-lg hover:bg-gray-50 
            transition-all duration-200 cursor-pointer">
    <span class="material-symbols-outlined">arrow_back</span>
    Voltar para Ficha
  </a>
</div>

<hr class="border-t border-gray-300 my-4">


<div class="flex justify-between bg-white p-6 rounded-lg shadow-sm border border-gray-200 mb-6">
  <div>
    <h2 class="text-2xl font-semibold mb-2 text-gray-800">
      <%= @ficha.cliente.cli_nome %>
    </h2>

    <p class="text-gray-600 mb-4">
      Valor atual da ficha:
      <span class="font-bold">
        <%= number_to_currency(@ficha.fic_valor_total) %>
      </span>
    </p>
  </div>

  
<div class="flex items-center justify-center">
      <div >
        <button onclick="abrirMovimentacaoModal('<%= new_movimentacao_crediario_path(ficha_crediario_id: @ficha.id) %>', 'Nova Movimentação')" class="bg-tags-rosa text-white rounded-lg font-medium hover:bg-tags-rosa-dark transition-colors duration-200 flex items-center gap-2 cursor-pointer px-4 py-2 flex-shrink-0">Nova Movimentação</button>

      </div>
    </div>
</div>



<% badge_classes = {
  "pagamento" => "bg-green-100 text-green-800 border-green-300",
  "compra"     => "bg-blue-100 text-blue-800 border-blue-300",
  "juros"      => "bg-orange-100 text-orange-800 border-orange-300",
  "devolucao"  => "bg-purple-100 text-purple-800 border-purple-300"
} %>

<% icon_for = {
  "pagamento" => "payments",
  "compra"    => "shopping_cart_checkout",
  "juros"     => "trending_up",
  "devolucao" => "undo"
} %>

<div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
  <table class="w-full text-left">
    <thead class="bg-gray-100 text-gray-700">
      <tr>
        <th class="px-6 py-3 font-medium">Movimentação</th>
        <th class="px-6 py-3 font-medium">Valor</th>
        <th class="px-6 py-3 font-medium">Valor Real</th>
        <th class="px-6 py-3 font-medium">Usuário</th>
        <th class="px-6 py-3 font-medium">Data</th>
        <th class="px-6 py-3 font-medium">Obs</th>
        <th class="px-6 py-3 font-medium">Ações</th>
      </tr>
    </thead>

    <tbody class="divide-y divide-gray-200 text-black">
      <% @movs.each do |m| %>
        <tr class="hover:bg-gray-50">
          <td class="px-6 py-3 font-medium">
            <span class="flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold border <%= badge_classes[m.mov_tipo] %>">
              <span class="material-symbols-outlined text-sm"><%= icon_for[m.mov_tipo] %></span>
              <%= m.mov_tipo.humanize %>
            </span>
          </td>
          <td class="px-6 py-3"><%= number_to_currency(m.mov_valor) %></td>
          <td class="px-6 py-3"><%= number_to_currency(m.mov_valor_real) %></td>
          <td class="px-6 py-3"><%= m.user.usu_nome %></td>
          <td class="px-6 py-3"><%= l m.created_at, format: :short %></td>
          <td class="px-6 py-3"><%= m.mov_observacao %></td>
          <td class="px-6 py-3 flex gap-3">
            <button onclick="abrirMovimentacaoModal('<%= edit_ficha_crediario_movimentacao_crediario_path(@ficha, m) %>', 'Editar Movimentação')" class="inline-flex items-center px-3 py-1 border border-indigo-600 rounded text-indigo-600 hover:bg-indigo-50 transition-colors duration-200 cursor-pointer">Editar</button>

            <button 
              onclick="excluirMov(this, '<%= ficha_crediario_movimentacao_crediario_path(@ficha, m) %>')" 
              class="inline-flex items-center px-3 py-1 border border-red-600 rounded text-red-600 hover:bg-red-50 transition-colors duration-200 cursor-pointer">
              Excluir
            </button>

          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>

<% modal_id = "movModal" %>
<% content_id = "movFormContent" %>
<% title = "Movimentação" %>
<% printable = false %>

<dialog id="<%= modal_id %>" class="modal-base">
  <div class="modal-container">
    <div class="modal-header no-print">
      <h3 id="<%= modal_id %>Title" class="modal-title"><%= title %></h3>
      <button onclick="fecharModal('<%= modal_id %>')" class="modal-close-btn">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
    <div class="modal-content-container">
      <div id="<%= content_id %>" class="modal-content">
        <div class="flex justify-center items-center py-8">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-tags-rosa"></div>
          <span class="ml-2 text-gray-600">Carregando...</span>
        </div>
      </div>
    </div>
  </div>
</dialog>



<script>
function abrirMovimentacaoModal(url, modalTitle = "Movimentação") {
  const modal = document.getElementById('movModal');
  const content = document.getElementById('movFormContent');
  const titleEl = document.getElementById('movModalTitle');

  titleEl.textContent = "Carregando...";
  content.innerHTML = `<div class="flex justify-center items-center py-8">
                          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-tags-rosa"></div>
                          <span class="ml-2 text-gray-600">Carregando...</span>
                       </div>`;
  modal.showModal();

  fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
    .then(r => r.text())
    .then(html => {
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const form = doc.querySelector('form');
      if (form) {
        content.innerHTML = form.outerHTML;
        titleEl.textContent = modalTitle;
      }
    })
    .catch(err => {
      content.innerHTML = `<div class="text-red-600 py-8 text-center">Erro: ${err.message}</div>`;
      titleEl.textContent = "Erro";
    });
}


function fecharModal(id) {
  document.getElementById(id).close();
}

function excluirMov(button, url) {
  fetch(url, {
    method: 'DELETE',
    headers: { 
      'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(res => {
    if(res.ok){
      // Remove a linha da tabela
      const row = button.closest('tr');
      if(row) row.remove();

      // Atualiza o valor total da ficha na tela
      const totalSpan = document.querySelector('#valor-total-ficha');
      if(totalSpan){
        fetch(window.location.href, { headers: { 'X-Requested-With': 'XMLHttpRequest' }})
          .then(r => r.text())
          .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const novoTotal = doc.querySelector('#valor-total-ficha');
            if(novoTotal) totalSpan.textContent = novoTotal.textContent;
          });
      }
    } else {
      res.text().then(text => console.error("Erro ao excluir: " + text));
    }
  })
  .catch(err => console.error(err));
}


// Intercepta submit do form no modal
document.addEventListener('submit', function(event){
  if(event.target.closest('#movFormContent')){
    event.preventDefault();
    const form = event.target;
    const data = new FormData(form);

    fetch(form.action, {
      method: form.method.toUpperCase(),
      body: data,
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    }).then(res => {
      if(res.ok){
        fecharModal('movModal');
        window.location.reload();
      } else {
        return res.text().then(html => {
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
          const form = doc.querySelector('form');
          if(form) document.getElementById('movFormContent').innerHTML = form.outerHTML;
        });
      }
    }).catch(err => console.error(err));
  }
});

</script>

<style>
/* Modal Base Styles */
.modal-base {
  border: none;
  padding: 0;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 95%;
  max-width: 700px;
  max-height: 80vh;
  border-radius: 12px;
  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
  overflow: hidden;
}

.modal-base[open] {
  animation: modalSlideIn 0.3s ease-out;
}

.modal-container {
  background: white;
  display: flex;
  flex-direction: column;
  height: 100%;
}

.modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 1rem 1.5rem;
  border-bottom: 1px solid #e5e7eb;
  background: white;
  position: sticky;
  top: 0;
  z-index: 10;
}

.modal-title { font-size: 1.125rem; font-weight: 600; color: #181818; margin: 0; }
.modal-close-btn { padding: 0.5rem; border-radius: 0.5rem; transition: background-color 0.2s; border: none; background: transparent; cursor: pointer; display: flex; align-items: center; justify-content: center; }
.modal-close-btn:hover { background-color: #f3f4f6; }

.modal-content-container { max-height: calc(80vh - 120px); overflow-y: auto; padding: 0 1.5rem; }
.modal-content { padding: 1.5rem 0; }
.modal-footer { display: flex; justify-content: flex-end; gap: 0.75rem; padding: 1rem 1.5rem; border-top: 1px solid #e5e7eb; background: white; position: sticky; bottom: 0; }

@keyframes modalSlideIn {
  from { opacity: 0; transform: translate(-50%, -48%) scale(0.95); }
  to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
}
</style>
