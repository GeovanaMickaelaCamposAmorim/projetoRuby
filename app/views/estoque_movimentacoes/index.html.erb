<% content_for :page_title, "Controle de Movimentações" %>
<% content_for :page_description, "Gerencie entradas e saídas de estoque" %>
<% content_for :page_icon do %>
  <span class="material-symbols-outlined text-xl">inventory_2</span>
<% end %>

<div class="container mx-auto">
  <div class="min-h-screen w-full">
    <!-- Cabeçalho -->
    <div class="flex-shrink-0">
      <div class="flex items-center justify-end">
        <!-- Botão Nova Movimentação -->
        <button onclick="abrirMovimentacaoModal('<%= new_estoque_movimentaco_path %>')" 
                class="px-6 py-3 bg-tags-rosa text-white rounded-lg font-medium hover:bg-tags-rosa-dark transition-colors duration-200 flex items-center gap-2 cursor-pointer">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
          </svg>
          Nova Movimentação
        </button>
      </div>
    </div>

    <hr class="border-t border-gray-300 my-4">

    <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-6">
      <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
        <p class="text-gray-600 font-medium">Total Movimentações</p>
        <p class="text-3xl font-bold text-gray-800"><%= @estoque_movimentacoes.count %></p>
      </div>
      <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
        <p class="text-gray-600 font-medium">Entradas</p>
        <p class="text-3xl font-bold text-green-600">
          <%= @estoque_movimentacoes.where(emv_tipo: ['reabastecimento', 'devolucao']).sum(:emv_quantidade).to_i %>
        </p>
      </div>
      <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
        <p class="text-gray-600 font-medium">Saídas</p>
        <p class="text-3xl font-bold text-red-600">
          <%= @estoque_movimentacoes.where(emv_tipo: ['retirada','venda','crediario']).sum(:emv_quantidade).to_i %>
        </p>
      </div>
    </div>


    <!-- Card branco envolvendo busca e grade -->
    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 mb-6">
      <!-- Filtros -->
      <%= form_with url: estoque_movimentacoes_path, method: :get, local: true, class: "mb-6" do %>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Produto</label>
            <%= select_tag :produto_id, options_from_collection_for_select(Produto.all, :id, :pro_descricao, params[:produto_id]), prompt: "Todos os produtos", class: "w-full p-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-[#ed215e] outline-none" %>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Tipo</label>
            <%= select_tag :emv_tipo, 
                  options_for_select([['Todos', ''],["Reabastecimento", "reabastecimento"], ["Retirada", "retirada"], ["Devolução", "devolucao"], ["Venda", "venda"]] , params[:emv_tipo]), 
                  class: "w-full p-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-[#ed215e] outline-none" %>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Usuário</label>
            <%= select_tag :user_id, options_for_select([['Todos', 'todos']] + @usuarios.map { |u| [u.usu_nome, u.id] }, params[:user_id] || 'todos'), class: "w-full p-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-[#ed215e] outline-none" %>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Cliente</label>
            <%= select_tag :cliente_id, 
                  options_from_collection_for_select(Cliente.all, :id, :cli_nome, params[:cliente_id]), 
                  prompt: "Todos os clientes", 
                  class: "w-full p-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-[#ed215e] outline-none" %>
          </div>

        </div>
        <div class="flex gap-2 justify-end">
          <%= submit_tag "Filtrar", class: "bg-tags-branco border border-tags-cinza text-tags-cinza hover:bg-tags-cinza hover:text-tags-branco font-medium py-2 px-4 rounded-lg transition-colors duration-200 cursor-pointer" %>
          <%= link_to "Limpar Filtros", estoque_movimentacoes_path, class: "bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200" %>
        </div>
      <% end %>

      <!-- Tabela -->
      <div class="overflow-hidden">
        <table class="w-full text-left">
          <thead class="bg-gray-100 text-gray-700">
            <tr>
              <th class="px-6 py-3 font-medium">Data</th>
              <th class="px-6 py-3 font-medium">Produto</th>
              <th class="px-6 py-3 font-medium">Quantidade</th>
              <th class="px-6 py-3 font-medium">Tipo</th>
              <th class="px-6 py-3 font-medium">Usuário</th>
              <th class="px-6 py-3 font-medium">Cliente</th>
              <th class="px-6 py-3 font-medium">Ações</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200 text-black">
            <% @estoque_movimentacoes.each do |mov| %>
              <tr>
                <td class="px-6 py-3"><%= l(mov.emv_data, format: :short) %></td>
                <td class="px-6 py-3"><%= mov.produto.pro_descricao %></td>
                <td class="px-6 py-3"><%= mov.emv_quantidade %></td>
                <td class="px-6 py-3"><%= mov.emv_tipo.titleize %></td>
                <td class="px-6 py-3"><%= mov.user.usu_nome %></td>
                <td class="px-6 py-3"><%= mov.cliente&.nome %></td>
                <td class="px-6 py-3 flex gap-3">
                  <button onclick="abrirMovimentacaoModal('<%= edit_estoque_movimentacao_path(mov) %>')" class="inline-flex items-center px-3 py-1 border border-indigo-600 rounded text-indigo-600 hover:bg-indigo-50 transition-colors duration-200 cursor-pointer">Editar</button>
                  <%= link_to "Excluir", estoque_movimentacao_path(mov), method: :delete, data: { confirm: 'Tem certeza que deseja excluir esta movimentação?' }, class: 'text-red-600 hover:text-red-900 font-medium text-sm px-3 py-1 border border-red-600 rounded hover:bg-red-50 transition-colors duration-200' %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal -->
<dialog id="movimentacaoModal" class="modal-base">
  <div class="modal-container">
    <div class="modal-header no-print">
      <h3 class="modal-title" id="movimentacaoModalTitle">Carregando...</h3>
      <button onclick="fecharModal('movimentacaoModal')" class="modal-close-btn">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
    <div class="modal-content-container">
      <div id="movimentacaoFormContent" class="modal-content">
        <div class="flex justify-center items-center py-8">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-tags-rosa"></div>
          <span class="ml-2 text-gray-600">Carregando...</span>
        </div>
      </div>
    </div>
  </div>
</dialog>

<script>
function atualizarCamposPorTipo(tipo) {
  const mostrarValor = ["reabastecimento", "devolucao", "venda"];
  const mostrarCliente = tipo === "crediario";

  const campoValorUnitario = document.getElementById("estoque_movimentacao_valor_unitario");
  const campoValorTotal   = document.getElementById("estoque_movimentacao_valor_total");
  const campoCliente      = document.getElementById("estoque_movimentacao_cliente_id");

  if(campoValorUnitario) campoValorUnitario.parentElement.classList.toggle("hidden", !mostrarValor.includes(tipo));
  if(campoValorTotal)   campoValorTotal.parentElement.classList.toggle("hidden", !mostrarValor.includes(tipo));
  if(campoCliente)      campoCliente.parentElement.classList.toggle("hidden", !mostrarCliente);

  // Limpar valores quando campo fica oculto
  if(!mostrarValor.includes(tipo)){
    if(campoValorUnitario) campoValorUnitario.value = '';
    if(campoValorTotal)   campoValorTotal.value = '';
  }
}

// Atualizar valor_total automaticamente
document.addEventListener('input', function(e){
  const unitField = document.getElementById("estoque_movimentacao_valor_unitario");
  const qtyField  = document.getElementById("estoque_movimentacao_quantidade");
  const totalField= document.getElementById("estoque_movimentacao_valor_total");

  if(unitField && qtyField && totalField){
    totalField.value = (parseFloat(unitField.value || 0) * parseInt(qtyField.value || 0)).toFixed(2);
  }
});


// Atualizar valor_total automaticamente
document.addEventListener('input', function(e){
  const unitField = document.getElementById("estoque_movimentacao_valor_unitario");
  const qtyField = document.getElementById("estoque_movimentacao_quantidade");
  const totalField = document.getElementById("estoque_movimentacao_valor_total");

  if(unitField && qtyField && totalField){
    totalField.value = (parseFloat(unitField.value || 0) * parseInt(qtyField.value || 0)).toFixed(2);
  }
});

function abrirModal(modalId) {
  const modal = document.getElementById(modalId);
  if(modal) modal.showModal();
}

function fecharModal(modalId) {
  const modal = document.getElementById(modalId);
  if(modal) modal.close();
}

async function abrirMovimentacaoModal(url) {
  try {
    document.getElementById('movimentacaoFormContent').innerHTML = `
      <div class="flex justify-center items-center py-8">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-tags-rosa"></div>
        <span class="ml-2 text-gray-600">Carregando...</span>
      </div>`;
    abrirModal('movimentacaoModal');

    const response = await fetch(url);
    const html = await response.text();
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    const formContent = doc.querySelector('form');

    if(formContent) {
      document.getElementById('movimentacaoFormContent').innerHTML = formContent.outerHTML;
      const modalTitle = document.getElementById('movimentacaoModalTitle');
      modalTitle.textContent = url.includes('new') ? 'Nova Movimentação' : 'Editar Movimentação';
    } else {
      document.getElementById('movimentacaoFormContent').innerHTML = `<div class="text-center py-8 text-red-600">Erro ao carregar formulário</div>`;
    }
  } catch(e) {
    document.getElementById('movimentacaoFormContent').innerHTML = `<div class="text-center py-8 text-red-600">Erro: ${e.message}</div>`;
  }
}

// Fechar modal com ESC ou backdrop
document.addEventListener('DOMContentLoaded', function(){
  const modal = document.getElementById('movimentacaoModal');
  if(modal){
    modal.addEventListener('cancel', ()=> modal.close());
    modal.addEventListener('click', e => { if(e.target===modal) modal.close(); });
  }
});

// Submit AJAX igual ao modal de Gastos
document.addEventListener('submit', function(event){
  if(event.target.closest('#movimentacaoFormContent')){
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);

    // Converter quantidade para inteiro
    const quantidadeField = form.querySelector('#estoque_movimentacao_quantidade');
    if(quantidadeField) formData.set('estoque_movimentacao[quantidade]', parseInt(quantidadeField.value));

    fetch(form.action, {
      method: form.method,
      body: formData,
      headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'text/html' }
    }).then(resp => {
      if(resp.ok){
        fecharModal('movimentacaoModal');
        window.location.reload();
      } else {
        return resp.text().then(html=>{
          const doc = new DOMParser().parseFromString(html,'text/html');
          const newForm = doc.querySelector('form');
          if(newForm){
            document.getElementById('movimentacaoFormContent').innerHTML = newForm.outerHTML;
          }
        });
      }
    }).catch(err => alert('Erro ao salvar movimentação'));
  }
});
</script>

<style>
/* Modal Base Styles */
.modal-base {
  border: none;
  padding: 0;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 95%;
  max-width: 700px;
  max-height: 80vh;
  border-radius: 12px;
  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
  overflow: hidden;
}

.modal-base[open] {
  animation: modalSlideIn 0.3s ease-out;
}

.modal-container {
  background: white;
  display: flex;
  flex-direction: column;
  height: 100%;
}

.modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 1rem 1.5rem;
  border-bottom: 1px solid #e5e7eb;
  background: white;
  position: sticky;
  top: 0;
  z-index: 10;
}

.modal-title { font-size: 1.125rem; font-weight: 600; color: #181818; margin: 0; }
.modal-close-btn { padding: 0.5rem; border-radius: 0.5rem; transition: background-color 0.2s; border: none; background: transparent; cursor: pointer; display: flex; align-items: center; justify-content: center; }
.modal-close-btn:hover { background-color: #f3f4f6; }

.modal-content-container { max-height: calc(80vh - 120px); overflow-y: auto; padding: 0 1.5rem; }
.modal-content { padding: 1.5rem 0; }
.modal-footer { display: flex; justify-content: flex-end; gap: 0.75rem; padding: 1rem 1.5rem; border-top: 1px solid #e5e7eb; background: white; position: sticky; bottom: 0; }

@keyframes modalSlideIn {
  from { opacity: 0; transform: translate(-50%, -48%) scale(0.95); }
  to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
}
</style>
