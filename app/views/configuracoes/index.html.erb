<div class="max-w-4xl mx-auto p-6">

  <div class="mb-8">
    <h1 class="text-2xl font-bold text-gray-900">Configurações</h1>
  </div>

  <%= form_with model: @configuracao, url: configuracoes_path, method: :patch, class: "space-y-8" do |form| %>

    <!-- Seção: Perfil da Loja -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Perfil da Loja</h2>
      
      <div class="space-y-6">

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Logo da Loja</label>
          <div class="flex items-center space-x-4">
            <div class="w-20 h-20 bg-gray-100 rounded-lg border-2 border-dashed border-gray-300 flex items-center justify-center logo-preview">
                <% if @configuracao.logo.attached? %>
                  <%= image_tag @configuracao.logo, class: "w-16 h-16 object-contain" %>
                <% else %>
                  <%= heroicon "arrow-up-tray", variant: :outline, options: { class: "h-6 w-6 text-gray-400" } %>
                <% end %>
            </div>
            
            <div>
              <%= form.file_field :logo, class: "hidden", id: "logo-upload" %>
              <button type="button" onclick="document.getElementById('logo-upload').click()" 
                      class="px-4 py-2 bg-tags-rosa text-white rounded-lg hover:bg-pink-600 transition-colors">
                Fazer Upload da Logo
              </button>
              <p class="text-xs text-gray-500 mt-1">PNG, JPG até 5MB</p>
            </div>  
          </div>
        </div>

        <div>
          <%= form.label :nome_loja, "Nome da Loja:", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= form.text_field :nome_loja, 
      class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-tags-rosa focus:border-transparent",
      placeholder: "Nome da sua loja" %>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <%= form.label :cnpj, "CNPJ:", class: "block text-sm font-medium text-gray-700 mb-2" %>
            <%= form.text_field :cnpj, class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-tags-rosa focus:border-transparent" %>
          </div>
          <div>
            <%= form.label :telefone, "Telefone:", class: "block text-sm font-medium text-gray-700 mb-2" %>
            <%= form.text_field :telefone, class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-tags-rosa focus:border-transparent" %>
          </div>
        </div>

        <div>
          <%= form.label :endereco, "Endereço:", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= form.text_field :endereco, class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-tags-rosa focus:border-transparent" %>
        </div>

        <div>
          <%= form.label :instagram, "Instagram:", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <div class="flex">
            <span class="inline-flex items-center px-3 rounded-l-lg border border-r-0 border-gray-300 bg-gray-50 text-gray-500">@</span>
            <%= form.text_field :instagram, class: "flex-1 px-3 py-2 border border-gray-300 rounded-r-lg focus:ring-2 focus:ring-tags-rosa focus:border-transparent" %>
          </div>
        </div>
      </div>
    </div>

    <div class="border-t border-gray-300 my-8"></div>

    <!-- Seção: Aparência do Sistema -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Aparência do Sistema</h2>
      
      <div class="space-y-6">
        <!-- Cor de Fundo do Menu -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-3">Cor de Fundo do Menu</label>
          
          <!-- Container principal - lado a lado -->
          <div class="flex items-center space-x-4">
            <!-- Cores pré-definidas -->
            <div class="flex space-x-3">
              <% cores_fundo = ['#181818', '#1f2937', '#374151'] %>
              <% cores_fundo.each do |cor| %>
                <label class="cursor-pointer">
                  <%= form.radio_button :cor_fundo_menu, cor, class: "hidden cor-fundo-radio" %>
                  <div class="w-10 h-10 rounded-lg border-2 border-transparent hover:border-gray-300 <%= 'border-tags-rosa border-2' if @configuracao.cor_fundo_menu == cor %>" 
                       style="background-color: <%= cor %>"
                       onclick="selecionarCorFundo('<%= cor %>')">
                  </div>
                </label>
              <% end %>
            </div>
            
            <!-- Divisória vertical -->
            <div class="h-8 w-px bg-gray-300"></div>
            
            <!-- Lado direito: Cores personalizadas -->
            <div class="flex items-center space-x-3">
              <!-- Cores personalizadas criadas -->
          
              <div id="opcoes-fundo-container" class="flex space-x-3">
                <!-- Aqui serão adicionadas as cores personalizadas -->
              </div>
              
              <!-- Botão + para adicionar cor personalizada -->
              <button type="button" 
                      onclick="mostrarInputCorPersonalizada('fundo')"
                      class="w-10 h-10 rounded-lg border-2 border-dashed border-gray-300 flex items-center justify-center hover:border-gray-400 hover:bg-gray-50 transition-colors">
                <%= heroicon "plus", variant: :outline, options: { class: "h-5 w-5 text-gray-400" } %>
              </button>
            </div>
          </div>
          
          <!-- Input para cor personalizada (inicialmente escondido) -->
          <div id="cor-personalizada-fundo-container" class="hidden mt-4">
            <div class="flex items-center space-x-3 bg-gray-50 p-4 rounded-lg">
              <div class="flex items-center space-x-2">
                <input type="color" 
                       id="color-picker-fundo"
                       value="<%= @configuracao.cor_fundo_menu.presence || '#181818' %>"
                       class="w-10 h-10 p-1 rounded-lg border border-gray-300 cursor-pointer"
                       onchange="atualizarPreviewCorFundo(this.value)">
                
                <input type="text" 
                       id="color-input-fundo"
                       value="<%= @configuracao.cor_fundo_menu.presence || '#181818' %>"
                       placeholder="#181818"
                       class="px-3 py-2 border border-gray-300 rounded-lg text-sm w-32 focus:ring-2 focus:ring-tags-rosa focus:border-transparent"
                       onchange="validarEAtualizarPreviewCorFundo(this.value)"
                       oninput="atualizarColorPicker(this.value, 'color-picker-fundo')">
                
                <button type="button" 
                        onclick="adicionarOpcaoCorPersonalizadaFundo()"
                        class="px-3 py-2 bg-tags-rosa text-white text-sm rounded-lg hover:bg-pink-600 transition-colors">
                  Adicionar
                </button>
                
                <button type="button" 
                        onclick="ocultarInputCorPersonalizada('fundo')"
                        class="px-3 py-2 bg-gray-300 text-gray-700 text-sm rounded-lg hover:bg-gray-400 transition-colors">
                  Cancelar
                </button>
              </div>
            </div>
          </div>
          
          <!-- Campo hidden para salvar a cor personalizada -->
          <%= form.hidden_field :cor_fundo_menu, id: "cor-fundo-final", value: @configuracao.cor_fundo_menu %>
        </div>

        <!-- Cor de Fonte do Menu -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-3">Cor de Fonte do Menu</label>
          
          <!-- Container principal - lado a lado -->
          <div class="flex items-center space-x-4">
            <!-- Cores pré-definidas -->
            <div class="flex space-x-3">
              <% cores_fonte = ['#f9fafb', '#e5e7eb', '#d1d5db'] %>
              <% cores_fonte.each do |cor| %>
                <label class="cursor-pointer">
                  <%= form.radio_button :cor_fonte_menu, cor, class: "hidden cor-fonte-radio" %>
                  <div class="w-10 h-10 rounded-lg border-2 border-transparent hover:border-gray-300 <%= 'border-tags-rosa border-2' if @configuracao.cor_fonte_menu == cor %>" 
                       style="background-color: <%= cor %>"
                       onclick="selecionarCorFonte('<%= cor %>')">
                  </div>
                </label>
              <% end %>
            </div>
            
            <!-- Divisória vertical -->
            <div class="h-8 w-px bg-gray-300"></div>
            
            <!-- Lado direito: Cores personalizadas -->
            <div class="flex items-center space-x-3">
              <!-- Cores personalizadas criadas -->
              <div id="opcoes-fonte-container" class="flex space-x-3">
                <!-- Aqui serão adicionadas as cores personalizadas -->
              </div>
              
              <!-- Botão + para adicionar cor personalizada -->
              <button type="button" 
                      onclick="mostrarInputCorPersonalizada('fonte')"
                      class="w-10 h-10 rounded-lg border-2 border-dashed border-gray-300 flex items-center justify-center hover:border-gray-400 hover:bg-gray-50 transition-colors">
                <%= heroicon "plus", variant: :outline, options: { class: "h-5 w-5 text-gray-400" } %>
              </button>
            </div>
          </div>
          
          <!-- Input para cor personalizada (inicialmente escondido) -->
          <div id="cor-personalizada-fonte-container" class="hidden mt-4">
            <div class="flex items-center space-x-3 bg-gray-50 p-4 rounded-lg">
              <div class="flex items-center space-x-2">
                <input type="color" 
                       id="color-picker-fonte"
                       value="<%= @configuracao.cor_fonte_menu.presence || '#f9fafb' %>"
                       class="w-10 h-10 p-1 rounded-lg border border-gray-300 cursor-pointer"
                       onchange="atualizarPreviewCorFonte(this.value)">
                
                <input type="text" 
                       id="color-input-fonte"
                       value="<%= @configuracao.cor_fonte_menu.presence || '#f9fafb' %>"
                       placeholder="#f9fafb"
                       class="px-3 py-2 border border-gray-300 rounded-lg text-sm w-32 focus:ring-2 focus:ring-tags-rosa focus:border-transparent"
                       onchange="validarEAtualizarPreviewCorFonte(this.value)"
                       oninput="atualizarColorPicker(this.value, 'color-picker-fonte')">
                
                <button type="button" 
                        onclick="adicionarOpcaoCorPersonalizadaFonte()"
                        class="px-3 py-2 bg-tags-rosa text-white text-sm rounded-lg hover:bg-pink-600 transition-colors">
                  Adicionar
                </button>
                
                <button type="button" 
                        onclick="ocultarInputCorPersonalizada('fonte')"
                        class="px-3 py-2 bg-gray-300 text-gray-700 text-sm rounded-lg hover:bg-gray-400 transition-colors">
                  Cancelar
                </button>
              </div>
            </div>
          </div>
          
          <!-- Campo hidden para salvar a cor personalizada -->
          <%= form.hidden_field :cor_fonte_menu, id: "cor-fonte-final", value: @configuracao.cor_fonte_menu %>
        </div>
      </div>
    </div>

    <!-- Debug temporário -->
    <%# <div class="bg-yellow-100 p-4 rounded mb-4">
      <h3 class="font-bold">Debug:</h3>
      <p>Cor Fundo: <%= @configuracao.cor_fundo_menu %></p>
      <%# <p>Cor Fonte: <%= @configuracao.cor_fonte_menu %></p>
      <%# <p>Configuração ID: <%= @configuracao.id %></p>
    <%# </div> %>

    <div class="flex justify-end pt-6">
      <%= form.submit "Salvar Configurações", 
            class: "px-6 py-3 bg-tags-rosa text-white font-medium rounded-lg hover:bg-pink-600 transition-colors cursor-pointer" %>
    </div>
  <% end %>
</div>

<script>
// Salvar cores personalizadas no localStorage
function salvarCoresPersonalizadas() {
  const coresFundo = Array.from(document.querySelectorAll('.cor-fundo-radio-personalizado'))
    .map(radio => radio.value);
  const coresFonte = Array.from(document.querySelectorAll('.cor-fonte-radio-personalizado'))
    .map(radio => radio.value);
  
  localStorage.setItem('cores_personalizadas_fundo', JSON.stringify(coresFundo));
  localStorage.setItem('cores_personalizadas_fonte', JSON.stringify(coresFonte));
}

// Carregar cores personalizadas do localStorage
function carregarCoresPersonalizadas() {
  const coresFundo = JSON.parse(localStorage.getItem('cores_personalizadas_fundo') || '[]');
  const coresFonte = JSON.parse(localStorage.getItem('cores_personalizadas_fonte') || '[]');
  
  coresFundo.forEach(cor => criarOpcaoCorFundo(cor));
  coresFonte.forEach(cor => criarOpcaoCorFonte(cor));
}

// Funções para criar as opções de cor
function criarOpcaoCorFundo(cor) {
  const container = document.getElementById('opcoes-fundo-container');
  const novaOpcao = document.createElement('label');
  novaOpcao.className = 'cursor-pointer';
  novaOpcao.innerHTML = `
    <input type="radio" name="configuracao[cor_fundo_menu]" value="${cor}" class="hidden cor-fundo-radio-personalizado">
    <div class="w-10 h-10 rounded-lg border-2 border-transparent hover:border-gray-300" 
         style="background-color: ${cor}"
         onclick="selecionarCorFundo('${cor}')">
    </div>
  `;
  container.appendChild(novaOpcao);
}

function criarOpcaoCorFonte(cor) {
  const container = document.getElementById('opcoes-fonte-container');
  const novaOpcao = document.createElement('label');
  novaOpcao.className = 'cursor-pointer';
  novaOpcao.innerHTML = `
    <input type="radio" name="configuracao[cor_fonte_menu]" value="${cor}" class="hidden cor-fonte-radio-personalizado">
    <div class="w-10 h-10 rounded-lg border-2 border-transparent hover:border-gray-300" 
         style="background-color: ${cor}"
         onclick="selecionarCorFonte('${cor}')">
    </div>
  `;
  container.appendChild(novaOpcao);
}

// Funções para mostrar/ocultar inputs personalizados
function mostrarInputCorPersonalizada(tipo) {
  if (tipo === 'fundo') {
    document.getElementById('cor-personalizada-fundo-container').classList.remove('hidden');
  } else {
    document.getElementById('cor-personalizada-fonte-container').classList.remove('hidden');
  }
}

function ocultarInputCorPersonalizada(tipo) {
  if (tipo === 'fundo') {
    document.getElementById('cor-personalizada-fundo-container').classList.add('hidden');
  } else {
    document.getElementById('cor-personalizada-fonte-container').classList.add('hidden');
  }
}

// Funções para cores personalizadas - FUNDO
function atualizarPreviewCorFundo(cor) {
  document.getElementById('color-input-fundo').value = cor;
}

function validarEAtualizarPreviewCorFundo(cor) {
  if (/^#[0-9A-F]{6}$/i.test(cor)) {
    document.getElementById('color-picker-fundo').value = cor;
  } else {
    alert('Por favor, insira um código de cor válido no formato #RRGGBB');
  }
}

function adicionarOpcaoCorPersonalizadaFundo() {
  const corPersonalizadaFundo = document.getElementById('color-input-fundo').value;
  
  if (/^#[0-9A-F]{6}$/i.test(corPersonalizadaFundo)) {
    criarOpcaoCorFundo(corPersonalizadaFundo);
    salvarCoresPersonalizadas();
    
    // Esconde o input e limpa campos
    ocultarInputCorPersonalizada('fundo');
    document.getElementById('color-input-fundo').value = '#';
    document.getElementById('color-picker-fundo').value = '#181818';
  } else {
    alert('Por favor, insira um código de cor válido no formato #RRGGBB');
  }
}

// Funções para cores personalizadas - FONTE
function atualizarPreviewCorFonte(cor) {
  document.getElementById('color-input-fonte').value = cor;
}

function validarEAtualizarPreviewCorFonte(cor) {
  if (/^#[0-9A-F]{6}$/i.test(cor)) {
    document.getElementById('color-picker-fonte').value = cor;
  } else {
    alert('Por favor, insira um código de cor válido no formato #RRGGBB');
  }
}

function adicionarOpcaoCorPersonalizadaFonte() {
  const corPersonalizadaFonte = document.getElementById('color-input-fonte').value;
  
  if (/^#[0-9A-F]{6}$/i.test(corPersonalizadaFonte)) {
    criarOpcaoCorFonte(corPersonalizadaFonte);
    salvarCoresPersonalizadas();
    
    // Esconde o input e limpa campos
    ocultarInputCorPersonalizada('fonte');
    document.getElementById('color-input-fonte').value = '#';
    document.getElementById('color-picker-fonte').value = '#f9fafb';
  } else {
    alert('Por favor, insira um código de cor válido no formato #RRGGBB');
  }
}

// Funções para selecionar cores
function selecionarCorFundo(cor) {
  console.log('Selecionando cor fundo:', cor);
  document.getElementById('cor-fundo-final').value = cor;
  aplicarCoresPreview();
}

function selecionarCorFonte(cor) {
  console.log('Selecionando cor fonte:', cor);
  document.getElementById('cor-fonte-final').value = cor;
  aplicarCoresPreview();
}

// Função auxiliar para atualizar color picker
function atualizarColorPicker(cor, pickerId) {
  if (/^#[0-9A-F]{6}$/i.test(cor)) {
    document.getElementById(pickerId).value = cor;
  }
}

// Função para aplicar cores em tempo real no preview
function aplicarCoresPreview() {
  console.log('Aplicando cores preview...');
  
  // Pega as cores selecionadas
  const corFundoSelecionada = document.getElementById('cor-fundo-final').value || '#181818';
  const corFonteSelecionada = document.getElementById('cor-fonte-final').value || '#f9fafb';
  
  console.log('Cor fundo:', corFundoSelecionada);
  console.log('Cor fonte:', corFonteSelecionada);
  
  // Atualiza o menu sidebar (se estiver visível na página)
  const sidebarMenu = document.getElementById('sidebar-menu');
  if (sidebarMenu) {
    sidebarMenu.style.backgroundColor = corFundoSelecionada;
    
    // Atualiza todos os textos do menu
    const textosMenu = sidebarMenu.querySelectorAll('span');
    textosMenu.forEach(texto => {
      texto.style.color = corFonteSelecionada;
    });
    
    // Atualiza ícones
    const icones = sidebarMenu.querySelectorAll('svg');
    icones.forEach(icone => {
      icone.style.color = corFonteSelecionada;
    });
    
    // Atualiza bordas
    const bordas = sidebarMenu.querySelectorAll('.border-t');
    bordas.forEach(borda => {
      borda.style.borderColor = corFonteSelecionada;
    });
  }
}

// Preview da logo antes do upload
document.getElementById('logo-upload')?.addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      const preview = document.querySelector('.logo-preview');
      if (preview) {
        preview.innerHTML = `<img src="${e.target.result}" class="w-16 h-16 object-contain" alt="Preview">`;
      }
    };
    reader.readAsDataURL(file);
  }
});

// Carregar cores quando a página carrega
document.addEventListener('DOMContentLoaded', function() {
  carregarCoresPersonalizadas();
  aplicarCoresPreview();
});

// Também funciona com Turbo
document.addEventListener('turbo:load', function() {
  carregarCoresPersonalizadas();
  aplicarCoresPreview();
});
</script>