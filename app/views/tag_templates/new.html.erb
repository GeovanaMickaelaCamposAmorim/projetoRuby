<% content_for :page_title, "Gerar Etiqueta" %>
<% content_for :page_description, "Crie etiquetas personalizadas para anexar às peças" %>
<% content_for :page_icon do %>
  <span class="material-symbols-outlined text-xl">sell</span>
<% end %>

<div class="h-fit-content flex flex-col py-4">
  <div class="grid grid-cols-1 xl:grid-cols-2 gap-4">
    
    <!-- Coluna 1: Preview da Etiqueta -->
    <div class="bg-white rounded-lg shadow border border-gray-200">
      <div class="p-4 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900">Preview da Etiqueta</h3>
      </div>
      
      <div class="p-4 flex items-center justify-center">
        <div class="w-72 h-100 relative border-2 border-gray-300 rounded-lg overflow-hidden bg-tags-branco shadow-lg" id="label-container" data-label-container>
          
          <!-- Parte de cima da etiqueta -->
          <div class="h-25 bg-[#4E4E4E] relative" data-label-top>
            <!-- Furinho da etiqueta -->
            <div class="absolute top-2 left-1/2 transform -translate-x-1/2 w-4 h-4 bg-white rounded-full border-2 border-[#4E4E4E]" data-label-hole></div>
          </div>
          
          <!-- Logo centralizada entre as partes -->
          <div class="absolute top-15 left-1/2 transform -translate-x-1/2 w-20 h-20 bg-white rounded-full border-4 border-[#4E4E4E] z-10 flex items-center justify-center" data-logo-border>
            <%= image_tag current_contratante.logo, class: "object-cover rounded-full" %>
          </div>
          
          <!-- Parte de baixo da etiqueta -->
         <div class="h-75 bg-white relative">
          
          <!-- Conteúdo da etiqueta -->
          <div class="relative z-10 p-3 h-full flex flex-col">
            <!-- Conteúdo principal centralizado -->
            <div class="flex-1 flex flex-col justify-center mb-2">
              <div class="text-center space-y-2">
                <!-- Nome principal -->
                <div class="">
                  <h3 class="font-bold text-gray-800 text-lg leading-tight uppercase" id="preview-product-name">
                    Nome do Produto
                  </h3>
                </div>
                
                <!-- Marca, Tamanho e Cor -->
                <div class="">
                  <p class="text-gray-700 text-sm font-medium leading-tight" id="preview-product-details">
                    <span id="preview-brand">Marca</span> - 
                    <span id="preview-size">P</span> / 
                    <span id="preview-color">Vermelha</span>
                  </p>
                </div>
                
                <!-- Código (menor e mais claro) -->
                <div class="">
                  <p class="text-gray-600 text-sm font-medium leading-tight" id="preview-product-code">
                    CAL-SHEIN-VER-P-001
                  </p>
                </div>
                
                <!-- Preço -->
                <div class="">
                  <p class="text-gray-800 font-bold text-xl leading-tight" id="preview-product-price">
                    R$ 35,00
                  </p>
                </div>
              </div>
            </div>
            
            <!-- Rodapé com contatos -->
            <div class="mt-auto">
              <div class="text-center space-y-1">
                <!-- Telefone -->
                <div class="">
                  <p class="text-gray-700 text-sm font-bold leading-tight" id="preview-phone">
                    (75) 91234-5678
                  </p>
                </div>
                <!-- Redes Sociais -->
                <div class="">
                  <div class="flex justify-center space-x-3">
                    <span class="text-gray-700 text-sm font-bold leading-tight" id="preview-instagram">@instagram</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        </div>
      </div>
    </div>

    <!-- Coluna 2: Formulário -->
    <div class="bg-white rounded-lg shadow border border-gray-200">
      <div class="p-4 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900">Configurações</h3>
      </div>
      
      <div class="p-4">
        <%= form_with(model: @tag_template, url: gerar_etiqueta_path, local: true, id: 'label-form', class: "space-y-4") do |form| %>
          
          <!-- Seleção do Produto -->
          <div>
            <h4 class="text-base font-semibold text-gray-900 mb-3">Selecionar Produto</h4>
            
            <div class="space-y-3">
              <div>
                <%= label_tag :product_id, "Produto em Estoque", class: "block text-sm font-medium text-gray-700 mb-1" %>
                <% 
                  produtos_options = if @produtos.present?
                    [['Selecione um produto', '']] + @produtos.map { |p| 
                      ["#{p.pro_nome} - #{p.marca&.nome} - #{p.tamanho&.tam_nome} / #{p.pro_cor}", p.id, 
                      data: { 
                        name: p.pro_nome,
                        brand: p.marca&.nome,
                        size: p.tamanho&.tam_nome,
                        color: p.pro_cor,
                        code: p.pro_codigo,
                        price: p.pro_valor_venda
                      }] 
                    }
                  else
                    [['Selecione um produto', ''], ['Nenhum produto cadastrado', '', disabled: true]]
                  end
                %>
                <%= select_tag :product_id, 
                      options_for_select(produtos_options, params[:product_id]),
                      class: "w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#ed215e] focus:border-transparent text-sm",
                      id: "product-select" %>
                
                <% if @produtos.blank? %>
                  <p class="text-xs text-red-600 mt-1">
                    Não há produtos cadastrados. 
                    <%= link_to "Cadastre produtos primeiro", produtos_path, class: "underline" %>
                  </p>
                <% end %>
              </div>
            </div>
          </div>

          <!-- Informações de Contato -->
          <div>
            <h4 class="text-base font-semibold text-gray-900 mb-3">Informações de Contato</h4>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
              <div>
                <%= label_tag :phone, "Telefone", class: "block text-sm font-medium text-gray-700 mb-1" %>
                <%= text_field_tag :phone, params[:phone] || "(75) 91234-5678", 
                      placeholder: "(75) 91234-5678",
                      class: "w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#ed215e] focus:border-transparent text-sm",
                      id: "contact-phone" %>
              </div>

              <div>
                <%= label_tag :instagram, "Instagram", class: "block text-sm font-medium text-gray-700 mb-1" %>
                <%= text_field_tag :instagram, params[:instagram] || "@instagram", 
                      placeholder: "@instagram",
                      class: "w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#ed215e] focus:border-transparent text-sm",
                      id: "contact-instagram" %>
              </div>
            </div>
          </div>

          <!-- Configuração da Tag -->
          <div>
            <h4 class="text-base font-semibold text-gray-900 mb-3">Configuração da Etiqueta</h4>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <div class="flex flex-col">
                <%= form.label :color, "Cor da etiqueta", class: "block text-sm font-medium text-gray-700 mb-1" %>
                <div class="flex items-center gap-2">
                  <%= form.color_field :color, value: @tag_template.color || "#4E4E4E", 
                        class: "w-12 h-12 border-2 border-gray-300 rounded-lg cursor-pointer",
                        id: "label-color-picker" %>
                  <%= form.text_field :color, value: @tag_template.color || "#4E4E4E", 
                        class: "w-32 border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#ed215e] focus:border-transparent text-sm font-mono",
                        id: "label-color" %>
                </div>
              </div>

              <div class="flex flex-col">
                <%= form.label :quantity, "Quantidade", class: "block text-sm font-medium text-gray-700 mb-1" %>
                <%= form.number_field :quantity, min: 1, max: 100, value: 1,
                      class: "w-32 border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#ed215e] focus:border-transparent text-sm",
                      id: "quantity-field" %>
              </div>
            </div>
          </div>

          <!-- Botões -->
          <div class="pt-6 border-t border-gray-200">
            <div class="flex flex-col sm:flex-row gap-3">
              <button type="button" id="cancel-button" 
                      class="sm:flex-1 px-6 py-3 border border-gray-300 text-gray-700 bg-white rounded-lg font-medium hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-500 transition-colors text-sm text-center cursor-pointer">
                Cancelar
              </button>
              
              <button type="button" id="preview-button" 
                      class="sm:flex-1 px-6 py-3 bg-tags-rosa text-white rounded-lg font-bold hover:bg-tags-rosa-dark focus:outline-none focus:ring-2 focus:ring-rosa-tags transition-colors text-sm cursor-pointer">
                Visualizar
              </button>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Layout de Impressão -->
  <div class="mt-8 bg-white rounded-lg shadow border border-gray-200">
    <div class="p-4 border-b border-gray-200">
      <div class="flex justify-between items-center">
        <h3 class="text-lg font-semibold text-gray-900">Layout de Impressão</h3>
        <div class="flex gap-2">
          <button id="clear-layout" 
                  class="px-4 py-2 border border-tags-cinza text-tags-cinza bg-tags-branco rounded-lg font-medium hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-500 transition-colors text-sm cursor-pointer">
            Limpar Layout
          </button>
          <button id="go-to-print" 
                  class="px-4 py-2 border border-tags-rosa bg-tags-branco text-tags-rosa rounded-lg font-bold hover:bg-tags-rosa/80 hover:text-tags-branco focus:outline-none focus:ring-2 focus:tags-rosa transition-colors text-sm cursor-pointer">
            Ir para Impressão
          </button>
        </div>
      </div>
    </div>
    
    <div class="p-4">
      <div id="layout-content" class="min-h-32 border-2 border-dashed border-gray-300 rounded-lg p-4">
        <div id="empty-layout-message" class="text-center text-gray-500 py-8">
          <svg class="w-12 h-12 mx-auto text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
          </svg>
          <p class="mt-2">Nenhuma etiqueta adicionada ao layout</p>
          <p class="text-sm">Use o botão "Visualizar e Adicionar ao Layout" para adicionar etiquetas</p>
        </div>
        
        <div id="layout-items" class="hidden space-y-4">
          <!-- Itens serão adicionados dinamicamente aqui -->
        </div>
      </div>
      
      <div id="layout-summary" class="hidden mt-4 bg-gray-50 rounded-lg p-4">
        <h4 class="font-semibold text-gray-900 mb-2">Resumo do Layout</h4>
        <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm">
          <div>
            <span class="text-gray-600">Total de Etiquetas:</span>
            <span id="total-tags" class="font-bold ml-1">0</span>
          </div>
          <div>
            <span class="text-gray-600">Páginas Estimadas:</span>
            <span id="total-pages" class="font-bold ml-1">0</span>
          </div>
          <div>
            <span class="text-gray-600">Tipos Diferentes:</span>
            <span id="different-types" class="font-bold ml-1">0</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Preview -->
<div id="preview-modal" class="fixed inset-0 overflow-y-auto h-full w-full z-50 hidden">
  <div class="fixed inset-0 bg-black/40 backdrop-blur-sm"></div>
  
  <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-4/5 lg:w-3/4 xl:w-2/3 shadow-2xl rounded-2xl bg-white max-h-[90vh] overflow-y-auto transform transition-all duration-300 scale-95">
    <!-- Header do Modal -->
    <div class="flex justify-between items-center mb-6 pb-4 border-b border-gray-100">
      <h3 class="text-xl font-bold text-gray-900">Preview da Etiqueta</h3>
      <button id="close-modal" class="text-gray-400 hover:text-gray-600 transition-colors duration-200 p-1 rounded-full hover:bg-gray-100">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>

    <!-- Preview etiqueta -->
    <div class="mb-6">
      <div class="flex justify-center">
        <div class="w-72 h-96 relative border-2 border-gray-200 rounded-xl overflow-hidden shadow-lg bg-white">
          <!-- Parte de cima da etiqueta -->
          <div class="h-25 relative" id="modal-label-top">
            <!-- Furinho da etiqueta -->
            <div class="absolute top-2 left-1/2 transform -translate-x-1/2 w-4 h-4 bg-white rounded-full border-2" id="modal-label-hole"></div>
          </div>
          
          <!-- Logo centralizada -->
          <div class="absolute top-15 left-1/2 transform -translate-x-1/2 w-20 h-20 bg-white rounded-full border-4 z-10 flex items-center justify-center shadow-lg" id="modal-logo-border">
            <%= image_tag current_contratante.logo, class: "object-cover rounded-full" %>
          </div>
          
          <!-- Parte de baixo da etiqueta -->
          <div class="h-70 bg-white relative">
            <div class="absolute inset-0 bg-linear-to-br from-white/80 to-gray-50/30"></div>
            
            <!-- Conteúdo da etiqueta -->
            <div class="relative z-10 p-3 h-full flex flex-col">
              <div class="flex-1 flex flex-col justify-center mb-2">
                <div class="text-center space-y-2">
                  <h3 class="font-bold text-gray-800 text-lg leading-tight" id="modal-product-name">
                    Calcinha de Renda
                  </h3>
                  
                  <p class="text-gray-700 text-sm font-medium leading-tight" id="modal-product-details">
                    <span id="modal-brand">Marca</span> - 
                    <span id="modal-size">P</span> / 
                    <span id="modal-color">Vermelha</span>
                  </p>
                  
                  <p class="text-gray-600 text-sm font-medium leading-tight" id="modal-product-code">
                    CAL-SHEIN-VER-P-001
                  </p>
                  
                  <p class="text-gray-800 font-bold text-xl leading-tight" id="modal-product-price">
                    R$ 35,00
                  </p>
                </div>
              </div>
              
              <div class="mt-auto">
                <div class="text-center space-y-1">
                  <p class="text-gray-700 text-sm font-bold leading-tight" id="modal-phone">
                    (75) 91234-5678
                  </p>
                  <div class="flex justify-center space-x-3">
                    <span class="text-gray-700 text-sm font-bold leading-tight" id="modal-instagram">@instagram</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Informações da Geração -->
    <div class="mb-2 bg-linear-to-r from-gray-50 to-gray-100 p-2 rounded-xl border border-gray-200">
      <h4 class="text-lg font-semibold text-gray-700 mb-2">Informações da Etiqueta</h4>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
        <div class="text-center">
          <span class="font-medium text-gray-600 block mb-1">Quantidade</span>
          <p class="text-gray-900 font-bold text-m" id="modal-quantity">1 etiqueta(s)</p>
        </div>
        <div class="text-center">
          <span class="font-medium text-gray-600 block mb-1">Cor</span>
          <p class="text-gray-900 font-bold text-m" id="modal-color-text">#4E4E4E</p>
        </div>
        <div class="text-center">
          <span class="font-medium text-gray-600 block mb-1">Produto</span>
          <p class="text-gray-900 font-bold text-m" id="modal-product-info">Calcinha de Renda</p>
        </div>
        <div class="text-center">
          <span class="font-medium text-gray-600 block mb-1">Preço</span>
          <p class="text-gray-900 font-bold text-m" id="modal-price-info">R$ 35,00</p>
        </div>
      </div>
    </div>

    <!-- Botões do Modal -->
    <div class="flex flex-col sm:flex-row justify-end space-y-3 sm:space-y-0 sm:space-x-4 pt-4 border-t border-gray-200">
      <button id="modal-cancel" class="px-8 py-3 border border-gray-300 text-gray-700 bg-white rounded-xl font-medium hover:bg-gray-50 transition-all duration-200 hover:shadow-sm">
        Cancelar
      </button>
      
      <button id="add-to-layout-btn" 
              class="px-8 py-3 bg-tags-rosa text-white rounded-xl font-medium hover:bg-tags-rosa-dark transition-all duration-200 hover:shadow-lg flex items-center justify-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
        </svg>
        Adicionar ao Layout
      </button>
    </div>
  </div>
</div>

<script>
// Sistema de Layout de Impressão
const LayoutManager = {
  items: [],

  init() {
    this.loadFromStorage();
    this.setupEventListeners();
    this.updateLayoutDisplay();
  },
  
  setupEventListeners() {
    document.getElementById('add-to-layout-btn')?.addEventListener('click', () => this.addCurrentToLayout());
    document.getElementById('clear-layout')?.addEventListener('click', () => this.clearLayout());
    document.getElementById('go-to-print')?.addEventListener('click', () => this.goToPrint());
  },
  
  addCurrentToLayout() {
    const formData = this.collectFormData();
    const quantity = parseInt(document.getElementById('quantity-field')?.value) || 1;
    
    const layoutItem = {
      id: Date.now() + Math.random(),
      ...formData,
      quantity: quantity,
      addedAt: new Date().toLocaleString('pt-BR')
    };
    
    this.items.push(layoutItem);
    this.saveToStorage();
    this.updateLayoutDisplay();
    this.closeModal();
    
    // Feedback
    this.showNotification(`${quantity} etiqueta(s) adicionada(s) ao layout!`);
  },
  
  collectFormData() {
    return {
      product_name: document.getElementById('modal-product-name')?.textContent?.trim() || 'Produto',
      brand: document.getElementById('modal-brand')?.textContent?.trim() || 'Marca',
      size: document.getElementById('modal-size')?.textContent?.trim() || 'Tamanho',
      color: document.getElementById('modal-color')?.textContent?.trim() || 'Cor',
      code: document.getElementById('modal-product-code')?.textContent?.trim() || 'COD-001',
      price: document.getElementById('modal-product-price')?.textContent?.trim() || 'R$ 0,00',
      phone: document.getElementById('modal-phone')?.textContent?.trim() || '(75) 91234-5678',
      instagram: document.getElementById('modal-instagram')?.textContent?.trim() || '@instagram',
      label_color: document.getElementById('label-color')?.value || '#4E4E4E'
    };
  },
  
  removeItem(id) {
    this.items = this.items.filter(item => item.id !== id);
    this.saveToStorage();
    this.updateLayoutDisplay();
  },
  
  clearLayout() {
    if (this.items.length === 0) return;
    
    if (confirm('Tem certeza que deseja limpar todo o layout? Todas as etiquetas serão removidas.')) {
      this.items = [];
      this.saveToStorage();
      this.updateLayoutDisplay();
      this.showNotification('Layout limpo com sucesso!');
    }
  },
  
  updateLayoutDisplay() {
    const layoutItems = document.getElementById('layout-items');
    const emptyMessage = document.getElementById('empty-layout-message');
    const summary = document.getElementById('layout-summary');
    
    if (this.items.length === 0) {
      layoutItems.classList.add('hidden');
      emptyMessage.classList.remove('hidden');
      summary.classList.add('hidden');
      return;
    }
    
    layoutItems.classList.remove('hidden');
    emptyMessage.classList.add('hidden');
    summary.classList.remove('hidden');
    
    // Atualizar itens
    layoutItems.innerHTML = this.items.map(item => `
      <div class="flex items-center justify-between p-3 bg-white border border-gray-200 rounded-lg">
        <div class="flex items-center space-x-4 flex-1">
          <div class="w-12 h-12 rounded border" style="background-color: ${item.label_color}"></div>
          <div class="flex-1">
            <h4 class="font-semibold text-gray-900 text-sm">${item.product_name}</h4>
            <p class="text-gray-600 text-xs">${item.brand} - ${item.size} / ${item.color}</p>
            <p class="text-gray-500 text-xs">Código: ${item.code} | Preço: ${item.price}</p>
          </div>
        </div>
        <div class="flex items-center space-x-4">
          <span class="bg-gray-100 text-gray-800 text-xs font-medium px-2.5 py-0.5 rounded">
            ${item.quantity} un.
          </span>
          <button onclick="LayoutManager.removeItem(${item.id})" 
                  class="text-red-600 hover:text-red-800 p-1 rounded transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
            </svg>
          </button>
        </div>
      </div>
    `).join('');
    
    // Atualizar resumo
    this.updateSummary();
  },
  
  updateSummary() {
    const totalTags = this.items.reduce((sum, item) => sum + item.quantity, 0);
    const totalPages = Math.ceil(totalTags / 9); // 9 etiquetas por página
    const differentTypes = new Set(this.items.map(item => item.code)).size;
    
    document.getElementById('total-tags').textContent = totalTags;
    document.getElementById('total-pages').textContent = totalPages;
    document.getElementById('different-types').textContent = differentTypes;
  },
  

  goToPrint() {
    if (this.items.length === 0) {
      alert('Adicione etiquetas ao layout antes de imprimir!');
      return;
    }
    
    const printData = {
      items: this.items,
      totalTags: this.items.reduce((sum, item) => sum + item.quantity, 0),
      generatedAt: new Date().toISOString()
    };
    
    
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/etiquetas/imprimir_layout';
    form.target = '_blank'; 
    
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'layout_data';
    input.value = JSON.stringify(printData);
    form.appendChild(input);
    
    // Adicionar CSRF token
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
    if (csrfToken) {
      const csrfInput = document.createElement('input');
      csrfInput.type = 'hidden';
      csrfInput.name = 'authenticity_token';
      csrfInput.value = csrfToken;
      form.appendChild(csrfInput);
    }
    
    document.body.appendChild(form);
    form.submit();
    document.body.removeChild(form);
  },
  
  showNotification(message) {
    // Criar notificação temporária
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300';
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.remove();
    }, 3000);
  },
  
  saveToStorage() {
    localStorage.setItem('tags_layout_items', JSON.stringify(this.items));
  },
  
  loadFromStorage() {
    const saved = localStorage.getItem('tags_layout_items');
    if (saved) {
      this.items = JSON.parse(saved);
    }
  },
  
  closeModal() {
    document.getElementById('preview-modal').classList.add('hidden');
  }
};

// Integrar com o TagGenerator existente
const TagGenerator = {
  initialized: false,
  
  init() {
    if (this.initialized) return;
    this.initialized = true;
    
    this.setupGlobalListeners();
    this.setupFormListeners();
    LayoutManager.init(); // Inicializar o gerenciador de layout
  },
  
  setupGlobalListeners() {
    document.addEventListener('click', (e) => this.handleGlobalClick(e));
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') this.closeModal();
    });
  },
  
  setupFormListeners() {
    // Sincronizar color picker
    const colorPicker = document.getElementById('label-color-picker');
    const colorInput = document.getElementById('label-color');
    
    if (colorPicker && colorInput) {
      colorPicker.addEventListener('input', (e) => {
        colorInput.value = e.target.value;
        this.updateLabelColor(e.target.value);
      });
      
      colorInput.addEventListener('input', (e) => {
        colorPicker.value = e.target.value;
        this.updateLabelColor(e.target.value);
      });
    }
    
    // Seleção de produto
    const productSelect = document.getElementById('product-select');
    if (productSelect) {
      productSelect.addEventListener('change', (e) => {
        this.updateProductFromSelect(e.target);
      });
    }
    
    // Contatos em tempo real
    ['contact-phone', 'contact-instagram'].forEach(id => {
      const element = document.getElementById(id);
      if (element) {
        element.addEventListener('input', (e) => {
          const previewId = id.replace('contact-', 'preview-');
          const previewElement = document.getElementById(previewId);
          if (previewElement) previewElement.textContent = e.target.value;
        });
      }
    });
    
    // Botão cancelar
    const cancelButton = document.getElementById('cancel-button');
    if (cancelButton) {
      cancelButton.addEventListener('click', () => this.clearForm());
    }
    
    // Botão preview
    const previewButton = document.getElementById('preview-button');
    if (previewButton) {
      previewButton.addEventListener('click', () => this.showPreviewModal());
    }
  },
  
  handleGlobalClick(e) {
    // Fechar modal
    if (e.target.closest('#close-modal') || e.target.closest('#modal-cancel')) {
      e.preventDefault();
      this.closeModal();
    }
    
    // Fechar modal no overlay
    if (e.target.id === 'preview-modal') {
      this.closeModal();
    }
  },
  
  updateLabelColor(color) {
    const elements = {
      top: document.querySelector('[data-label-top]'),
      hole: document.querySelector('[data-label-hole]'),
      logo: document.querySelector('[data-logo-border]')
    };
    
    Object.values(elements).forEach(el => {
      if (el) {
        if (el === elements.hole || el === elements.logo) {
          el.style.borderColor = color;
        } else {
          el.style.backgroundColor = color;
        }
      }
    });
  },
  
  updateProductFromSelect(select) {
    const selectedOption = select.options[select.selectedIndex];
    if (!selectedOption.value) return;
    
    const data = {
      name: selectedOption.getAttribute('data-name'),
      brand: selectedOption.getAttribute('data-brand'),
      size: selectedOption.getAttribute('data-size'),
      color: selectedOption.getAttribute('data-color'),
      code: selectedOption.getAttribute('data-code'),
      price: selectedOption.getAttribute('data-price')
    };
    
    // Atualizar preview
    if (data.name) document.getElementById('preview-product-name').textContent = data.name;
    if (data.brand) document.getElementById('preview-brand').textContent = data.brand;
    if (data.size) document.getElementById('preview-size').textContent = data.size;
    if (data.color) document.getElementById('preview-color').textContent = data.color;
    if (data.code) document.getElementById('preview-product-code').textContent = data.code;
    
    if (data.price) {
      const formattedPrice = 'R$ ' + parseFloat(data.price).toFixed(2).replace('.', ',');
      document.getElementById('preview-product-price').textContent = formattedPrice;
    }
  },
  
  showPreviewModal() {
    const currentColor = document.getElementById('label-color')?.value || '#4E4E4E';
    const quantity = parseInt(document.getElementById('quantity-field')?.value) || 1;
    
    // Atualizar dados no modal
    const updates = {
      'modal-product-name': 'preview-product-name',
      'modal-brand': 'preview-brand',
      'modal-size': 'preview-size', 
      'modal-color': 'preview-color',
      'modal-product-code': 'preview-product-code',
      'modal-product-price': 'preview-product-price',
      'modal-phone': 'preview-phone',
      'modal-instagram': 'preview-instagram'
    };
    
    Object.entries(updates).forEach(([modalId, previewId]) => {
      const previewElement = document.getElementById(previewId);
      const modalElement = document.getElementById(modalId);
      if (previewElement && modalElement) {
        modalElement.textContent = previewElement.textContent;
      }
    });
    
    // Atualizar informações
    document.getElementById('modal-quantity').textContent = `${quantity} etiqueta(s)`;
    document.getElementById('modal-color-text').textContent = currentColor;
    document.getElementById('modal-product-info').textContent = 
      document.getElementById('preview-product-name')?.textContent || 'Produto';
    document.getElementById('modal-price-info').textContent = 
      document.getElementById('preview-product-price')?.textContent || 'R$ 0,00';
    
    // Atualizar cores
    document.getElementById('modal-label-top').style.backgroundColor = currentColor;
    document.getElementById('modal-label-hole').style.borderColor = currentColor;
    document.getElementById('modal-logo-border').style.borderColor = currentColor;
    
    // Mostrar modal
    document.getElementById('preview-modal').classList.remove('hidden');
  },
  
  closeModal() {
    document.getElementById('preview-modal').classList.add('hidden');
  },
  
  clearForm() {
    // Resetar seleção de produto
    const productSelect = document.getElementById('product-select');
    if (productSelect) productSelect.selectedIndex = 0;
    
    // Resetar valores padrão
    const defaults = {
      'preview-product-name': 'Nome do Produto',
      'preview-brand': 'Marca',
      'preview-size': 'P',
      'preview-color': 'Vermelha', 
      'preview-product-code': 'CAL-SHEIN-VER-P-001',
      'preview-product-price': 'R$ 35,00',
      'preview-phone': '(75) 91234-5678',
      'preview-instagram': '@instagram',
      'contact-phone': '(75) 91234-5678',
      'contact-instagram': '@instagram',
      'label-color': '#4E4E4E',
      'label-color-picker': '#4E4E4E',
      'quantity-field': '1'
    };
    
    Object.entries(defaults).forEach(([id, value]) => {
      const element = document.getElementById(id);
      if (element) {
        if (element.type === 'text' || element.type === 'color' || element.type === 'number') {
          element.value = value;
        } else {
          element.textContent = value;
        }
      }
    });
    
    this.updateLabelColor('#4E4E4E');
  }
};

// Inicialização
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => TagGenerator.init());
} else {
  TagGenerator.init();
}

document.addEventListener('turbo:load', () => {
  TagGenerator.initialized = false;
  setTimeout(() => TagGenerator.init(), 100);
});
</script>