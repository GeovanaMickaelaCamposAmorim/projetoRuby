<% content_for :page_title, "Controle de Gastos" %>
<% content_for :page_description, "Gerencie e monitore seus gastos" %>
<% content_for :page_icon do %>
  <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
  </svg>
<% end %>

<div class="container mx-auto flex">
  <div class="min-h-screen w-full">
    <!-- Cabeçalho -->
    <div class="p-4 flex-shrink-0">
      <div class="flex items-center justify-end">
        
        
        <!-- Botão corrigido para ir para new_gasto_path -->
        <%= link_to new_gasto_path, class: "px-6 py-3 bg-tags-rosa text-white rounded-lg font-medium hover:bg-[#d91956] transition-colors duration-200" do %>
          + Registrar Gasto
        <% end %>
      </div>
    </div>

    <!-- Cards resumo -->
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-6">
      <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
        <p class="text-gray-600 font-medium">Total de Gastos</p>
        <p class="text-3xl font-bold text-red-600"><%= number_to_currency(@gastos.sum(&:gas_valor)) %></p>
      </div>
      <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
        <p class="text-gray-600 font-medium">Gastos Este Mês</p>
        <p class="text-3xl font-bold text-gray-800"><%= number_to_currency(@total_mes) %></p>
      </div>
      <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
        <p class="text-gray-600 font-medium">Média Mensal</p>
        <%
          # Cálculo simples da média mensal (últimos 6 meses)
          media_mensal = @gastos.where('gas_data >= ?', 6.months.ago).sum(:gas_valor) / 6.0
        %>
        <p class="text-3xl font-bold text-gray-800"><%= number_to_currency(media_mensal) %></p>
      </div>
    </div>

    <!-- Card branco envolvendo busca e grade -->
    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 mb-6">
      <!-- Formulário de Filtros -->
      <%= form_with url: gastos_path, method: :get, local: true, class: "mb-6" do %>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
          <!-- Filtro por Descrição -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Descrição</label>
            <%= text_field_tag :search, params[:search], 
                  placeholder: "Buscar por descrição",
                  class: "w-full p-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-[#ed215e] outline-none" %>
          </div>
          
          <!-- Filtro por Mês (independente) -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Mês</label>
            <%= select_tag :mes, 
                  options_for_select([
                    ['Todos os meses', ''],
                    ['Janeiro', 1],
                    ['Fevereiro', 2],
                    ['Março', 3],
                    ['Abril', 4],
                    ['Maio', 5],
                    ['Junho', 6],
                    ['Julho', 7],
                    ['Agosto', 8],
                    ['Setembro', 9],
                    ['Outubro', 10],
                    ['Novembro', 11],
                    ['Dezembro', 12]
                  ], params[:mes]), 
                  class: "w-full p-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-[#ed215e] outline-none" %>
          </div>
          
          <!-- Filtro por Ano (independente) -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Ano</label>
            <%= select_tag :ano, 
                  options_for_select(
                    [['Todos os anos', '']] + 
                    (2020..Date.today.year).to_a.reverse.map { |ano| [ano, ano] },
                    params[:ano]
                  ), 
                  class: "w-full p-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-[#ed215e] outline-none" %>
          </div>
          
          <!-- Filtro por Usuário -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Usuário</label>
            <%= select_tag :usuario_id, 
                  options_for_select(
                    [['Todos os usuários', 'todos']] + 
                    @usuarios.map { |usuario| [usuario.usu_nome, usuario.id] },
                    params[:usuario_id] || 'todos'
                  ), 
                  class: "w-full p-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-[#ed215e] outline-none" %>
          </div>
        </div>
        
        <!-- Botões de ação dos filtros -->
        <div class="flex gap-2">
          <%= submit_tag "Filtrar", class: "bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200" %>
          <%= link_to "Limpar Filtros", gastos_path, class: "bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200" %>
        </div>
      <% end %>

      <!-- Tabela -->
      <div class="overflow-hidden">
        <table class="w-full text-left">
          <thead class="bg-gray-100 text-gray-700">
            <tr>
              <th class="px-6 py-3 font-medium">Data</th>
              <th class="px-6 py-3 font-medium">Descrição</th>
              <th class="px-6 py-3 font-medium">Valor</th>
              <th class="px-6 py-3 font-medium">Usuário</th>
              <th class="px-6 py-3 font-medium">Ações</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200 text-black">
            <% @gastos.each do |gasto| %>
              <tr>
                <td class="px-6 py-3"><%= gasto.gas_data.strftime('%d/%m/%Y') %></td>
                <td class="px-6 py-3"><%= gasto.gas_descricao %></td>
                <td class="px-6 py-3 text-red-600 font-semibold"><%= number_to_currency(gasto.gas_valor) %></td>
                <td class="px-6 py-3"><%= gasto.user.usu_nome %></td>
                <td class="px-6 py-3 flex gap-3">
                  <%= link_to "Editar", edit_gasto_path(gasto), class: 'text-blue-600 hover:text-blue-900 font-medium text-sm px-3 py-1 border border-blue-600 rounded hover:bg-blue-50 transition-colors duration-200' %>
                  <%= link_to "Excluir", gasto_path(gasto), 
                      method: :delete, 
                      data: { confirm: 'Tem certeza que deseja excluir este gasto?' },
                      class: 'text-red-600 hover:text-red-900 font-medium text-sm px-3 py-1 border border-red-600 rounded hover:bg-red-50 transition-colors duration-200' %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>