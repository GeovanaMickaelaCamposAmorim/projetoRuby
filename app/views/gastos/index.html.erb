<% content_for :page_title, "Controle de Gastos" %>
<% content_for :page_description, "Gerencie e monitore seus gastos" %>
<% content_for :page_icon do %>
  <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
  </svg>
<% end %>

<div class="container mx-auto">
  <div class="min-h-screen w-full">
    <!-- Cabeçalho -->
    <div class="flex-shrink-0">
      <div class="flex items-center justify-end">
        <!-- Botão Novo Gasto -->
        <button onclick="abrirGastoModal('<%= new_gasto_path %>')" 
                class="px-6 py-3 bg-tags-rosa text-white rounded-lg font-medium hover:bg-tags-rosa-dark transition-colors duration-200 flex items-center gap-2 cursor-pointer">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
          </svg>
          Novo Gasto
        </button>
      </div>
    </div>

    <hr class="border-t border-gray-300 my-4">

    <!-- Cards resumo -->
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-6">
      <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
        <p class="text-gray-600 font-medium">Total de Gastos</p>
        <p class="text-3xl font-bold text-red-600"><%= number_to_currency(@gastos.sum(&:gas_valor)) %></p>
      </div>
      <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
        <p class="text-gray-600 font-medium">Gastos Este Mês</p>
        <p class="text-3xl font-bold text-gray-800"><%= number_to_currency(@total_mes) %></p>
      </div>
      <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
        <p class="text-gray-600 font-medium">Média Mensal</p>
        <%
          media_mensal = @gastos.where('gas_data >= ?', 6.months.ago).sum(:gas_valor) / 6.0
        %>
        <p class="text-3xl font-bold text-gray-800"><%= number_to_currency(media_mensal) %></p>
      </div>
    </div>

    <!-- Card branco envolvendo busca e grade -->
    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 mb-6">
      <!-- Formulário de Filtros -->
      <%= form_with url: gastos_path, method: :get, local: true, class: "mb-6" do %>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
          <!-- Filtro por Descrição -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Descrição</label>
            <%= text_field_tag :search, params[:search], 
                  placeholder: "Buscar por descrição",
                  class: "w-full p-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-[#ed215e] outline-none" %>
          </div>
          
          <!-- Filtro por Mês -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Mês</label>
            <%= select_tag :mes, 
                  options_for_select([
                    ['Todos os meses', ''],
                    ['Janeiro', 1],
                    ['Fevereiro', 2],
                    ['Março', 3],
                    ['Abril', 4],
                    ['Maio', 5],
                    ['Junho', 6],
                    ['Julho', 7],
                    ['Agosto', 8],
                    ['Setembro', 9],
                    ['Outubro', 10],
                    ['Novembro', 11],
                    ['Dezembro', 12]
                  ], params[:mes]), 
                  class: "w-full p-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-[#ed215e] outline-none" %>
          </div>
          
          <!-- Filtro por Ano -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Ano</label>
            <%= select_tag :ano, 
                  options_for_select(
                    [['Todos os anos', '']] + 
                    (2020..Date.today.year).to_a.reverse.map { |ano| [ano, ano] },
                    params[:ano]
                  ), 
                  class: "w-full p-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-[#ed215e] outline-none" %>
          </div>
          
          <!-- Filtro por Usuário -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Usuário</label>
            <%= select_tag :usuario_id, 
                  options_for_select(
                    [['Todos os usuários', 'todos']] + 
                    @usuarios.map { |usuario| [usuario.usu_nome, usuario.id] },
                    params[:usuario_id] || 'todos'
                  ), 
                  class: "w-full p-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-[#ed215e] outline-none" %>
          </div>
        </div>
        
        <!-- Botões de ação dos filtros -->
        <div class="flex gap-2 justify-end">
          <%= submit_tag "Filtrar", class: "bg-tags-branco border border-tags-cinza text-tags-cinza hover:bg-tags-cinza hover:text-tags-branco font-medium py-2 px-4 rounded-lg transition-colors duration-200 cursor-pointer" %>
          <%= link_to "Limpar Filtros", gastos_path, class: "bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200" %>
        </div>
      <% end %>

      <!-- Tabela -->
      <div class="overflow-hidden">
        <table class="w-full text-left">
          <thead class="bg-gray-100 text-gray-700">
            <tr>
              <th class="px-6 py-3 font-medium">Data</th>
              <th class="px-6 py-3 font-medium">Descrição</th>
              <th class="px-6 py-3 font-medium">Valor</th>
              <th class="px-6 py-3 font-medium">Usuário</th>
              <th class="px-6 py-3 font-medium">Ações</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200 text-black">
            <% @gastos.each do |gasto| %>
              <tr>
                <td class="px-6 py-3"><%= gasto.gas_data.strftime('%d/%m/%Y') %></td>
                <td class="px-6 py-3"><%= gasto.gas_descricao %></td>
                <td class="px-6 py-3 text-red-600 font-semibold"><%= number_to_currency(gasto.gas_valor) %></td>
                <td class="px-6 py-3"><%= gasto.user.usu_nome %></td>
                <td class="px-6 py-3 flex gap-3">
                  <!-- Botão Editar -->
                  <button onclick="abrirGastoModal('<%= edit_gasto_path(gasto) %>')" 
                          class="inline-flex items-center px-3 py-1 border border-indigo-600 rounded text-indigo-600 hover:bg-indigo-50 transition-colors duration-200 cursor-pointer">
                    Editar
                  </button>
                  
                  <%= link_to "Excluir", gasto_path(gasto), 
                        method: :delete, 
                        data: { confirm: 'Tem certeza que deseja excluir este gasto?' },
                        class: 'text-red-600 hover:text-red-900 font-medium text-sm px-3 py-1 border border-red-600 rounded hover:bg-red-50 transition-colors duration-200' %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal para Gastos - DIRETO NA PÁGINA -->
<dialog id="gastoModal" class="modal-base">
  <div class="modal-container">
    <!-- Header -->
    <div class="modal-header no-print">
      <h3 class="modal-title" id="gastoModalTitle">Carregando...</h3>
      <button onclick="fecharModal('gastoModal')" class="modal-close-btn">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>

    <!-- Content -->
    <div class="modal-content-container">
      <div id="gastoFormContent" class="modal-content">
        <div class="flex justify-center items-center py-8">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-tags-rosa"></div>
          <span class="ml-2 text-gray-600">Carregando...</span>
        </div>
      </div>
    </div>

    <!-- Footer - REMOVIDO O BOTÃO FECHAR -->
    <div class="modal-footer no-print">
      <!-- Botão Fechar removido - já temos o X e Cancelar nos formulários -->
    </div>
  </div>
</dialog>

<script>
// Funções globais para modais
function abrirModal(modalId) {
  const modal = document.getElementById(modalId);
  if (modal) {
    modal.showModal();
  }
}

function fecharModal(modalId) {
  const modal = document.getElementById(modalId);
  if (modal) {
    modal.close();
  }
}

// Função para abrir modal de gastos
async function abrirGastoModal(url) {
  try {
    // Mostrar loading
    document.getElementById('gastoFormContent').innerHTML = `
      <div class="flex justify-center items-center py-8">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-tags-rosa"></div>
        <span class="ml-2 text-gray-600">Carregando...</span>
      </div>
    `;

    // Abrir modal
    abrirModal('gastoModal');

    // Buscar o formulário
    const response = await fetch(url);
    const html = await response.text();
    
    // Extrair apenas o conteúdo do formulário
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    const formContent = doc.querySelector('form');
    
    if (formContent) {
      document.getElementById('gastoFormContent').innerHTML = formContent.outerHTML;
      
      // Atualizar o título do modal
      const modalTitle = document.getElementById('gastoModalTitle');
      if (modalTitle) {
        const isNew = url.includes('new');
        modalTitle.textContent = isNew ? 'Novo Gasto' : 'Editar Gasto';
      }
    } else {
      document.getElementById('gastoFormContent').innerHTML = `
        <div class="text-center py-8 text-red-600">
          Erro ao carregar formulário
        </div>
      `;
    }
    
  } catch (error) {
    console.error('Erro:', error);
    document.getElementById('gastoFormContent').innerHTML = `
      <div class="text-center py-8 text-red-600">
        Erro: ${error.message}
      </div>
    `;
  }
}

// Função para lidar com submit do formulário
function handleGastoSubmit(event) {
  event.preventDefault();
  
  const form = event.target;
  const formData = new FormData(form);
  
  fetch(form.action, {
    method: form.method,
    body: formData,
    headers: {
      'X-Requested-With': 'XMLHttpRequest',
      'Accept': 'text/html'
    }
  })
  .then(response => {
    if (response.ok) {
      // Fechar modal e recarregar a página
      fecharModal('gastoModal');
      window.location.reload();
    } else {
      // Mostrar erros de validação
      return response.text().then(html => {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const errorForm = doc.querySelector('form');
        if (errorForm) {
          document.getElementById('gastoFormContent').innerHTML = errorForm.outerHTML;
        }
      });
    }
  })
  .catch(error => {
    console.error('Erro:', error);
    alert('Erro ao salvar gasto');
  });
}

// Adicionar event listener para forms dinâmicos
document.addEventListener('submit', function(event) {
  if (event.target.closest('#gastoFormContent')) {
    handleGastoSubmit(event);
  }
});

// Fechar modal com ESC e backdrop
document.addEventListener('DOMContentLoaded', function() {
  const modal = document.getElementById('gastoModal');
  if (modal) {
    modal.addEventListener('cancel', function() {
      this.close();
    });
    
    modal.addEventListener('click', function(event) {
      if (event.target === this) {
        this.close();
      }
    });
  }
});
</script>

<style>
/* Modal Base Styles */
.modal-base {
  border: none;
  padding: 0;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 95%;
  max-width: 700px;
  max-height: 80vh;
  border-radius: 12px;
  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
  overflow: hidden;
}

.modal-base[open] {
  animation: modalSlideIn 0.3s ease-out;
}

.modal-container {
  background: white;
  display: flex;
  flex-direction: column;
  height: 100%;
}

.modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between; 
  padding: 1rem 1.5rem; 
  border-bottom: 1px solid #e5e7eb;
  background: white;
  position: sticky;
  top: 0;
  z-index: 10;
}

.modal-title {
  font-size: 1.125rem;
  font-weight: 600;
  color: #181818;
  margin: 0; 
}

.modal-close-btn {
  padding: 0.5rem;
  border-radius: 0.5rem;
  transition: background-color 0.2s;
  border: none;
  background: transparent;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.modal-close-btn:hover {
  background-color: #f3f4f6;
}

.modal-content-container {
  max-height: calc(80vh - 120px);
  overflow-y: auto;
  padding: 0 1.5rem;
}

.modal-content {
  padding: 1.5rem 0; 
}

.modal-footer {
  display: flex;
  justify-content: flex-end;
  gap: 0.75rem;
  padding: 1rem 1.5rem;
  border-top: 1px solid #e5e7eb;
  background: white;
  position: sticky;
  bottom: 0;
}

@keyframes modalSlideIn {
  from {
    opacity: 0;
    transform: translate(-50%, -48%) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
  }
}
</style>