<% content_for :page_title, "Movimentações da Ficha" %>
<% content_for :page_description, "Gerencie e monitore movimentações dos crediários" %>
<% content_for :page_icon do %>
  <span class="material-symbols-outlined text-xl">payments</span>
<% end %>

<hr class="border-t border-gray-300 my-4">

<div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 mb-6">
  <h2 class="text-2xl font-semibold mb-2 text-gray-800">
    <%= @ficha.cliente.cli_nome %>
  </h2>

  <p class="text-gray-600 mb-4">
    Valor atual da ficha:
    <span class="font-bold">
      <%= number_to_currency(@ficha.fic_valor_total) %>
    </span>
  </p>

  <button 
  onclick="abrirMovModal('<%= new_ficha_crediario_movimentacao_crediario_path(@ficha) %>')" 
  class="bg-tags-rosa text-white px-4 py-2 rounded-lg hover:bg-tags-rosa-dark transition cursor-point">
  Nova Movimentação
  </button>

</div>

<% badge_classes = {
  "pagamento" => "bg-green-100 text-green-800 border-green-300",
  "compra"     => "bg-blue-100 text-blue-800 border-blue-300",
  "juros"      => "bg-orange-100 text-orange-800 border-orange-300",
  "devolucao"  => "bg-purple-100 text-purple-800 border-purple-300"
} %>

<% icon_for = {
  "pagamento" => "payments",
  "compra"    => "shopping_cart_checkout",
  "juros"     => "trending_up",
  "devolucao" => "undo"
} %>

<div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
  <table class="w-full text-left">
    <thead class="bg-gray-100 text-gray-700">
      <tr>
        <th class="px-6 py-3 font-medium">Movimentação</th>
        <th class="px-6 py-3 font-medium">Valor</th>
        <th class="px-6 py-3 font-medium">Valor Real</th>
        <th class="px-6 py-3 font-medium">Usuário</th>
        <th class="px-6 py-3 font-medium">Data</th>
        <th class="px-6 py-3 font-medium">Obs</th>
        <th class="px-6 py-3 font-medium">Ações</th>
      </tr>
    </thead>

    <tbody class="divide-y divide-gray-200 text-black">
      <% @movs.each do |m| %>
        <tr class="hover:bg-gray-50">

          <td class="px-6 py-3 font-medium">
            <span class="flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold border <%= badge_classes[m.mov_tipo] %>">
              <span class="material-symbols-outlined text-sm"><%= icon_for[m.mov_tipo] %></span>
              <%= m.mov_tipo.humanize %>
            </span>
          </td>

          <td class="px-6 py-3"><%= number_to_currency(m.mov_valor) %></td>
          <td class="px-6 py-3"><%= number_to_currency(m.mov_valor_real) %></td>
          <td class="px-6 py-3"><%= m.user.usu_nome %></td>
          <td class="px-6 py-3"><%= l m.created_at, format: :short %></td>
          <td class="px-6 py-3"><%= m.mov_observacao %></td>

          <td class="px-6 py-3 flex gap-3">

            <button 
              onclick="abrirMovModal('<%= edit_ficha_crediario_movimentacao_crediario_path(@ficha, m) %>')" 
              class="inline-flex items-center px-3 py-1 border border-indigo-600 rounded text-indigo-600 hover:bg-indigo-50 transition-colors duration-200 cursor-pointer">
              Editar
            </button>

            
            <%= link_to "Excluir",
                ficha_crediario_movimentacao_crediario_path(@ficha, m),
                data: { turbo_method: :delete, turbo_confirm: "Tem certeza que deseja excluir esta movimentação?" },
                class: "inline-flex items-center px-3 py-1 border border-red-600 rounded text-red-600 hover:bg-red-50 transition-colors duration-200 cursor-pointer" %>

          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>

<dialog id="movModal" class="modal-base">
  <div class="modal-container">
    <div class="modal-header no-print">
      <h3 class="modal-title" id="movModalTitle">Carregando...</h3>
      <button onclick="fecharModal('movModal')" class="modal-close-btn">
        <span class="material-symbols-outlined text-xl">close</span>
      </button>
    </div>

    <div class="modal-content-container">
      <div id="movFormContent" class="modal-content">
        <div class="flex justify-center items-center py-8">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-tags-rosa"></div>
          <span class="ml-2 text-gray-600">Carregando...</span>
        </div>
      </div>
    </div>

    <div class="modal-footer"></div>
  </div>
</dialog>

<script>
function abrirMovModal(url) {
  const modal = document.getElementById("movModal");

  document.getElementById("movFormContent").innerHTML = `
    <div class="flex justify-center items-center py-8">
      <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-tags-rosa"></div>
      <span class="ml-2 text-gray-600">Carregando...</span>
    </div>
  `;

  modal.showModal();

  fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" }})
    .then(res => res.text())
    .then(html => {
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, "text/html");
      const form = doc.querySelector("form");

      if (form) {
        document.getElementById("movFormContent").innerHTML = form.outerHTML;
        document.getElementById("movModalTitle").textContent =
          url.includes("/new") ? "Nova Movimentação" : "Editar Movimentação";
      } else {
        document.getElementById("movFormContent").innerHTML =
          "<div class='py-8 text-center text-red-600'>Erro ao carregar formulário</div>";
      }
    });
}

function fecharMovModal() {
  const modal = document.getElementById("movModal");
  if (modal) modal.close();
}

// Captura submit dentro do modal
document.addEventListener("submit", function (event) {
  if (event.target.closest("#movFormContent")) {
    event.preventDefault();
    const form = event.target;
    const data = new FormData(form);

    fetch(form.action, {
      method: form.method,
      body: data,
      headers: { "X-Requested-With": "XMLHttpRequest" }
    }).then(res => {
      if (res.ok) {
        fecharMovModal();
        window.location.reload();
      } else {
        res.text().then(html => {
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, "text/html");
          const form = doc.querySelector("form");
          document.getElementById("movFormContent").innerHTML =
            form ? form.outerHTML : "Erro ao salvar.";
        });
      }
    });
  }
});
</script>

<dialog id="movModal" class="modal-base">
  <div class="modal-container">
    <div class="modal-header">
      <h3 class="modal-title" id="movModalTitle">Carregando...</h3>

      <button onclick="fecharMovModal()" class="modal-close-btn">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>

    <div class="modal-content-container">
      <div id="movFormContent" class="modal-content">
        <div class="flex justify-center items-center py-8">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-tags-rosa"></div>
          <span class="ml-2 text-gray-600">Carregando...</span>
        </div>
      </div>
    </div>
  </div>
</dialog>
